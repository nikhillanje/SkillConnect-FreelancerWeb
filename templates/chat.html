{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <link rel="stylesheet" href="{% static 'css/chat.css' %}">
</head>

<body>
    <div class="chat-wrapper">

        <!-- Chat Header -->
        <div class="chat-header">
            <img src="{{ receiver_profile_pic }}" alt="Avatar" class="chat-avatar">
            <div class="chat-name">{{ receiver_name }}</div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-box" id="chat-box">
            {% for msg in messages %}
            <div class="chat-message {% if msg.sender_type == user_type %}me{% else %}them{% endif %}">
                {% if msg.message %}
                <p>{{ msg.message }}</p>
                {% endif %}

                {% if msg.file %}
                {% if msg.file_type == "video" %}
                <video controls width="220">
                    <source src="{{ msg.file.url }}" type="video/mp4">
                </video>
                {% elif msg.file_type == "image" %}
                <img src="{{ msg.file.url }}" width="220" alt="file">
                {% else %}
                <a href="{{ msg.file.url }}" target="_blank">{{ msg.file.name|slice:"15" }}</a>
                {% endif %}
                {% endif %}

                <span class="time">{{ msg.timestamp|date:"H:i" }}</span>
            </div>
            {% empty %}
            <p style="text-align:center; color:#888;">No messages yet. Start chatting!</p>
            {% endfor %}
        </div>

        <!-- File Preview -->
        <div id="file-preview" style="display:none;"></div>

        <!-- Chat Input -->
        <div class="chat-input">
            <!-- File Upload -->
            <label for="file-input" class="file-label" title="Attach file">
                ðŸ“Ž
            </label>
            <input type="file" id="file-input" name="file">

            <!-- Message Input -->
            <input type="text" id="message-input" placeholder="Type a message...">

            <!-- Send Button -->
            <button id="send-btn">âž¤</button>
        </div>
    </div>

    <script>
        const sendBtn = document.getElementById("send-btn");
        const messageInput = document.getElementById("message-input");
        const chatBox = document.getElementById("chat-box");
        const fileInput = document.getElementById("file-input");
        const filePreview = document.getElementById("file-preview");

        // Auto scroll to bottom on page load
        chatBox.scrollTop = chatBox.scrollHeight;

        // Show selected file preview
        fileInput.addEventListener("change", function () {
            filePreview.style.display = "block";
            const file = this.files[0];
            if (file) {
                if (file.type.startsWith("image/")) {
                    filePreview.innerHTML = `<strong>Selected:</strong> <br><img src="${URL.createObjectURL(file)}">`;
                } else if (file.type.startsWith("video/")) {
                    filePreview.innerHTML = `<strong>Selected:</strong> <br><video width="120" controls><source src="${URL.createObjectURL(file)}"></video>`;
                } else {
                    filePreview.innerHTML = `<strong>Selected file:</strong> ${file.name}`;
                }
            }
        });

        // Send message function
        sendBtn.addEventListener("click", function () {
            sendMessage();
        });

        messageInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") sendMessage();
        });

        function sendMessage() {
            const message = messageInput.value.trim();
            const file = fileInput.files[0];

            if (!message && !file) return; // Don't send empty

            const formData = new FormData();
            formData.append("message", message);
            if (file) formData.append("file", file);

            // Include receiver data inside POST body
            formData.append("receiver_type", "{{ receiver_type }}");
            formData.append("receiver_id", "{{ receiver_id }}");

            fetch("{% url 'send_chat_ajax' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        appendMessage(data);
                        messageInput.value = "";
                        fileInput.value = "";
                        filePreview.style.display = "none";
                    }
                });
        }

        function appendMessage(data) {
            const div = document.createElement("div");
            div.className = `chat-message me`;
            if (data.message) div.innerHTML += `<p>${data.message}</p>`;
            if (data.file_url) {
                if (data.file_type === "image") {
                    div.innerHTML += `<img src="${data.file_url}" width="220">`;
                } else if (data.file_type === "video") {
                    div.innerHTML += `<video controls width="220"><source src="${data.file_url}" type="video/mp4"></video>`;
                } else {
                    div.innerHTML += `<a href="${data.file_url}" target="_blank">${data.file_name}</a>`;
                }
            }
            div.innerHTML += `<span class="time">${data.timestamp}</span>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>

</body>

</html>